<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>SCR Management System</title>

  <!-- Google Font (Roboto) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" 
    rel="stylesheet"
  />

  <style>
    /* --------------------------------------
       1) RESET & BASE
    ----------------------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: "Roboto", sans-serif; /* Updated font */
      background-color: #f4f4f9; 
      color: #333;
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    /* --------------------------------------
       2) LOGIN STYLES
    ----------------------------------------- */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      position: relative;
      z-index: 2;
    }

    /* Video Background */
    .video-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    .video-background video {
      position: absolute;
      top: 50%;
      left: 50%;
      min-width: 100%;
      min-height: 100%;
      transform: translate(-50%, -50%);
      object-fit: cover;
      filter: brightness(0.5);
    }

    /* Dark Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        to bottom right,
        rgba(0, 0, 0, 0.6),
        rgba(0, 0, 0, 0.2)
      );
      z-index: 1;
    }

    /* Login Box */
    .login-box {
      width: 100%;
      max-width: 400px;
      background: #ffffff;
      padding: 30px 25px;
      border-radius: 12px;
      box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.8s ease-in-out;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      z-index: 3;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-box h2 {
      font-size: 1.8rem;
      color: #0056b3;
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 700;
    }

    .login-box label {
      font-size: 0.9rem;
      margin-bottom: 4px;
      font-weight: 500;
      color: #333;
    }

    .login-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      background-color: #f9f9f9;
      color: #333;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .login-box input:focus {
      outline: none;
      border-color: #0056b3;
      box-shadow: 0 0 6px rgba(0, 86, 179, 0.4);
    }

    .login-box button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      color: #fff;
      background-color: #0056b3;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s, transform 0.2s;
    }
    .login-box button:hover {
      background-color: #003d80;
      transform: translateY(-2px);
    }

    .error-message {
      color: red;
      font-size: 0.9rem;
      text-align: center;
      display: none;
    }

    /* --------------------------------------
       3) HEADER & NAV
    ----------------------------------------- */
    header {
      display: none; /* shown after login */
      background: linear-gradient(to right, #0056b3, #0074e8);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5rem;
      box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.15);
    }
    header h1 {
      margin-bottom: 10px;
      font-size: 1.8rem;
      font-weight: 700;
    }
    header nav a {
      display: inline-block;
      padding: 8px 16px;
      background-color: #3498db;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
      margin: 0 5px;
      transition: background-color 0.3s;
    }
    header nav a:hover {
      background-color: #2e86c1;
    }

    /* --------------------------------------
       4) MAIN CONTAINER
    ----------------------------------------- */
    .container {
      display: none; /* shown after login */
      margin: 30px auto;
      padding: 20px;
      max-width: 1200px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* Button Group (New Slot, etc.) */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .btn-group button {
      padding: 10px 18px;
      font-size: 1rem;
      color: #fff;
      background-color: #0056b3;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s, box-shadow 0.2s;
    }
    .btn-group button:hover {
      background-color: #003d80;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Back to Top */
    #backToTop {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 16px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s, transform 0.2s;
      display: none;
    }
    #backToTop:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    /* --------------------------------------
       5) FORMS SECTION (NEW/CANCEL)
    ----------------------------------------- */
    .form-section {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
      background-color: #fafafa;
      margin-bottom: 20px;
      transition: box-shadow 0.3s;
    }
    .form-section:hover {
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    .form-section h3 {
      margin-bottom: 15px;
      color: #0056b3;
      font-size: 1.25rem;
      font-weight: 600;
    }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 10px;
      align-items: center;
    }
    .form-group label {
      flex: 1;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .form-group input,
    .form-group select {
      flex: 2;
      padding: 10px;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .form-group input:focus,
    .form-group select:focus {
      border-color: #0056b3;
      box-shadow: 0 0 5px rgba(0, 86, 179, 0.5);
      outline: none;
    }
    .delete-button {
      margin-left: 10px;
      background-color: #c0392b !important; /* red for delete */
      font-weight: 600;
    }

    /* --------------------------------------
       6) AIRPORT CONTAINERS
    ----------------------------------------- */
    .airport-container {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      padding: 15px;
      text-align: left;
      position: relative;
      transition: box-shadow 0.3s;
    }
    .airport-container:hover {
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .airport-header {
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .airport-header span {
      font-weight: 700;
      color: #0056b3;
    }
    .airport-header button {
      padding: 6px 10px;
      background-color: #3498db;
      border: none;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .airport-header button:hover {
      background-color: #2e86c1;
    }
    .scr-messages {
      display: none;
      margin-top: 10px;
    }
    .scr-message {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      white-space: pre-wrap;
      font-family: monospace;
      line-height: 1.4;
    }
    .scr-message:hover {
      background-color: #fdfdfd;
    }

    /* The "EMAIL SCR" button inside the container */
    .airport-container button.email-scr-btn {
      margin-bottom: 15px;
      padding: 8px 14px;
      background-color: #007BFF;
      border-radius: 6px;
      margin-top: -5px;
      transition: background-color 0.3s;
    }
    .airport-container button.email-scr-btn:hover {
      background-color: #0063cc;
    }

    /* --------------------------------------
       7) LOG SECTION
    ----------------------------------------- */
    #logContainer {
      display: none;
      margin-top: 30px;
    }
    #logContainer h3 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #0056b3;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    table th,
    table td {
      padding: 12px;
      text-align: left;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    table th {
      background-color: #0056b3;
      color: white;
      font-weight: 700;
    }
    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* CSV Button */
    #logContainer button {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      background-color: #3498db;
      color: #fff;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #logContainer button:hover {
      background-color: #2e86c1;
    }

    /* --------------------------------------
       8) SCR CHANGE REQUEST (Hidden by default)
    ----------------------------------------- */
    #changeSCRContainer {
      display: none;
      margin-top: 30px;
      background: #f7faff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    #changeSCRContainer h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
      font-size: 1.6rem;
      font-weight: 700;
    }
    .main-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .button-container {
      text-align: center;
      margin: 15px 0;
    }
    .button-container .btn {
      display: inline-block;
      margin: 5px;
      padding: 8px 14px;
      font-size: 0.9rem;
      background-color: #3498db;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .button-container .btn:hover {
      background-color: #2980b9;
    }
    .requests-container {
      background-color: #fff;
      border-radius: 6px;
      margin-bottom: 15px;
      padding: 15px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s;
    }
    .requests-container:hover {
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .requests-container h2 {
      color: #2c3e50;
      border-left: 4px solid #3498db;
      padding-left: 8px;
      margin-bottom: 10px;
      font-size: 1rem;
      font-weight: 600;
    }
    .requests-container form {
      margin-bottom: 15px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .form-group {
      align-items: center;
      min-width: 130px;
    }
    .form-group label {
      margin-right: 6px;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .form-group input,
    .form-group select {
      width: 110px;
      padding: 4px;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      border-radius: 3px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 3px rgba(52,152,219,0.2);
    }
    input[type="date"] {
      width: 120px;
    }
    input[type="text"] {
      text-transform: none;
    }
    .output-list {
      margin-top: 20px;
    }
    .scr-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .scr-info-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .airport-code {
      font-weight: 700;
      font-size: 1rem;
      color: #2c3e50;
    }
    .button-group {
      display: flex;
      gap: 5px;
    }
    .button-group button {
      padding: 5px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #fff;
      transition: background-color 0.3s;
    }
    .email-btn {
      background-color: #333; 
    }
    .email-btn:hover {
      background-color: #111;
    }
    .toggle-btn {
      background-color: #555; 
      width: 35px;
      text-align: center;
      padding: 5px;
    }
    .toggle-btn:hover {
      background-color: #222;
    }
    .scr-message-change {
      margin-left: 20px;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f5f5f5;
      border-left: 4px solid #333;
      white-space: pre;
      display: none;
      border-radius: 6px;
    }
    .scr-message-change:hover {
      background-color: #fdfdfd;
    }

  </style>
</head>
<body>

  <!-- LOGIN SECTION -->
  <div class="login-container">
    <div class="video-background">
      <video autoplay muted loop playsinline>
        <source src="assets/videos/background.mp4" type="video/mp4"/>
        <!-- A fallback image or message can go here if needed. -->
      </video>
    </div>
    <div class="overlay"></div>

    <form class="login-box" onsubmit="return false;">
      <h2>Login</h2>
      <div class="error-message" id="errorMessage">Invalid username or password</div>

      <label for="username">Username</label>
      <input type="text" id="username" placeholder="Enter username"/>

      <label for="password">Password</label>
      <input type="password" id="password" placeholder="Enter password"/>

      <button type="button" onclick="login()">Login</button>
    </form>
  </div>

  <!-- HEADER -->
  <header>
    <h1>Airport Runway Slots</h1>
    <nav>
      <a href="airport-search.html">Advanced Airport Search</a>
    </nav>
  </header>

  <!-- MAIN CONTAINER -->
  <div class="container">
    <!-- BUTTON GROUP (MAIN) -->
    <div class="btn-group">
      <button type="button" onclick="createForm('New Slot')">New Slot</button>
      <button type="button" onclick="createForm('Cancel Slot')">Cancel Slot</button>
      <button type="button" onclick="toggleChangeSCR()">Change Slot</button>
      <button type="button" onclick="showLog()">Log</button>
      <!-- New RESET ALL button -->
      <button type="button" onclick="resetAll()">Reset All</button>
      <!-- End New RESET ALL button -->
      <button id="backToTop" type="button" onclick="scrollToTop()">Back to Top</button>
    </div>

    <!-- FORMS CONTAINER (NEW/CANCEL) -->
    <div id="formsContainer"></div>

    <!-- LOG SECTION -->
    <div id="logContainer">
      <h3>Message Log</h3>
      <table id="logTable">
        <thead>
          <tr>
            <th>Slot Type</th>
            <th>SCR Message</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" onclick="downloadCSV()">Download CSV</button>
    </div>

    <!-- SCR CHANGE REQUEST SECTION -->
    <div id="changeSCRContainer">
      <div class="main-container">
        <h1>SCR Change Message Requests</h1>
        <nav style="margin-bottom: 20px;">
          <a href="index.html" style="
            display: inline-block;
            padding: 8px 12px;
            background-color: #3498db;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;">
            Back to Home
          </a>
        </nav>

        <div id="formsWrapper"></div>

        <div class="button-container">
          <button class="btn" id="addFormsBtn">Add More Requests</button>
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn" id="showSCRBtn">Show SCR Messages</button>
        </div>

        <div id="outputList" class="output-list"></div>
      </div>
    </div>
  </div>

  <!-- HIDDEN TEMPLATE FOR THE SCR CHANGE REQUEST FORMS -->
  <template id="formsTemplate">
    <div class="requests-container">
      <h3>Request #</h3>
      <h2>Old Request</h2>
      <form class="old-request-form">
        <div class="form-row">
          <div class="form-group">
            <label>Slot</label>
            <select required name="slotType">
              <option value="" disabled selected>-</option>
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="form-group">
            <label>Airport</label>
            <input type="text" name="airport" placeholder="DUB">
          </div>
          <div class="form-group">
            <label>Flight</label>
            <input type="text" name="flightNo" placeholder="FR123">
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date">
          </div>
          <div class="form-group">
            <label>Seats</label>
            <input type="number" name="seats" placeholder="189">
          </div>
          <div class="form-group">
            <label>A/C</label>
            <input type="text" name="acType" placeholder="73H">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" name="time" placeholder="2000">
          </div>
          <div class="form-group">
            <label>D/O</label>
            <input type="text" name="do" placeholder="STN">
          </div>
          <div class="form-group">
            <label>STC</label>
            <select required name="stc">
              <option value="" disabled selected>-</option>
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
            </select>
          </div>
        </div>
      </form>

      <h2>New Request</h2>
      <form class="new-request-form">
        <div class="form-row">
          <div class="form-group">
            <label>Slot</label>
            <select required name="slotType">
              <option value="" disabled selected>-</option>
              <option value="Arrival">Arrival</option>
              <option value="Departure">Departure</option>
            </select>
          </div>
          <div class="form-group">
            <label>Airport</label>
            <input type="text" name="airport" placeholder="DUB">
          </div>
          <div class="form-group">
            <label>Flight</label>
            <input type="text" name="flightNo" placeholder="FR123">
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date">
          </div>
          <div class="form-group">
            <label>Seats</label>
            <input type="number" name="seats" placeholder="189">
          </div>
          <div class="form-group">
            <label>A/C</label>
            <input type="text" name="acType" placeholder="73H">
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="text" name="time" placeholder="2100">
          </div>
          <div class="form-group">
            <label>D/O</label>
            <input type="text" name="do" placeholder="STN">
          </div>
          <div class="form-group">
            <label>STC</label>
            <select required name="stc">
              <option value="" disabled selected>-</option>
              <option value="P">P</option>
              <option value="D">D</option>
              <option value="T">T</option>
              <option value="K">K</option>
              <option value="J">J</option>
            </select>
          </div>
        </div>
      </form>
    </div>
  </template>

  <script>
    /********************************************************
      GLOBAL VARIABLES & INITIALIZATION
    ********************************************************/
    let airportEmails = {};   // from assets/emails.json
    let logData = [];         // holds the logs for NEW/CANCEL
    let formsData = [];       // forms for NEW/CANCEL
    let slotAction = '';      // "NEW SLOT" or "CANCEL SLOT"

    // For "CHANGE SCR" code:
    let requestCount = 0;
    const dayOfOperationMap = {
      0: '0000007', // Sunday
      1: '1000000', // Monday
      2: '0200000', // Tuesday
      3: '0030000', // Wednesday
      4: '0004000', // Thursday
      5: '0000500', // Friday
      6: '0000060', // Saturday
    };

    // "CHANGE SCR" references
    const formsWrapper  = document.getElementById('formsWrapper');
    const outputList    = document.getElementById('outputList');
    const formsTemplate = document.getElementById('formsTemplate');

    // Initialize events
    document.addEventListener('DOMContentLoaded', () => {
      const addFormsBtn   = document.getElementById('addFormsBtn');
      const resetBtn      = document.getElementById('resetBtn');
      const showSCRBtn    = document.getElementById('showSCRBtn');

      if (addFormsBtn) {
        addFormsBtn.addEventListener('click', addFormsPair);
      }
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          formsWrapper.innerHTML = '';
          outputList.innerHTML   = '';
          requestCount = 0;
          addFormsPair();
        });
      }
      if (showSCRBtn) {
        showSCRBtn.addEventListener('click', showSCRMessagesChange);
      }

      // Start with one pair of forms for CHANGE SCR
      addFormsPair();
    });

    /********************************************************
      LOGIN LOGIC
    ********************************************************/
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorMessage = document.getElementById('errorMessage');

      // Update these credentials as needed:
      if (username === "root" && password === "root") {
        document.querySelector('.login-container').style.display = 'none'; 
        document.querySelector('header').style.display = 'block';
        document.querySelector('.container').style.display = 'block';
        document.body.style.backgroundColor = '#f4f4f9';
      } else {
        errorMessage.style.display = 'block';
      }
    }

    // Load email data from JSON
    window.onload = loadEmailData;
    async function loadEmailData() {
      try {
        const response = await fetch('assets/emails.json');
        airportEmails = await response.json();
      } catch (error) {
        console.error('Error loading email data:', error);
        alert('Failed to load email data. Please check your JSON file.');
      }
    }

    // BACK TO TOP LOGIC
    window.onscroll = function() {
      const backToTopButton = document.getElementById('backToTop');
      if (document.documentElement.scrollTop > 200 || document.body.scrollTop > 200) {
        backToTopButton.style.display = 'block';
      } else {
        backToTopButton.style.display = 'none';
      }
    };
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /********************************************************
      NEW/CANCEL SLOT FORMS LOGIC
    ********************************************************/
    function createForm(action) {
      slotAction = action.toUpperCase();
      formsData = [];
      const formsContainer = document.getElementById('formsContainer');
      formsContainer.innerHTML = '';
      addMoreForm();
    }

    function addMoreForm() {
      const formsContainer = document.getElementById('formsContainer');
      const formWrapper = document.createElement('div');
      formWrapper.classList.add('form-section');
      const formId = 'form-' + (formsData.length + 1);
      formWrapper.id = 'wrapper-' + formId;

      formWrapper.innerHTML = `
        <h3>${slotAction} Form #${formsData.length + 1}</h3>
        <div class="form-group">
          <label for="slotType-${formId}">Slot Type:</label>
          <select id="slotType-${formId}">
            <option value="ARRIVAL">ARRIVAL</option>
            <option value="DEPARTURE">DEPARTURE</option>
          </select>
        </div>
        <div class="form-group">
          <label for="airportCode-${formId}">Airport (3 Letters):</label>
          <input type="text" id="airportCode-${formId}" maxlength="3" placeholder="e.g., VLC">
        </div>
        <div class="form-group">
          <label for="flightNumber-${formId}">Flight No.:</label>
          <input type="text" id="flightNumber-${formId}" placeholder="e.g., FR6060">
        </div>
        <div class="form-group">
          <label for="date-${formId}">Date:</label>
          <input type="date" id="date-${formId}">
        </div>
        <div class="form-group">
          <label for="numberOfSeats-${formId}">Seats:</label>
          <input type="number" id="numberOfSeats-${formId}" placeholder="189" oninput="validateSeats(this)">
        </div>
        <div class="form-group">
          <label for="aircraftType-${formId}">Aircraft:</label>
          <input type="text" id="aircraftType-${formId}" placeholder="e.g., 73H">
        </div>
        <div class="form-group">
          <label for="time-${formId}">Time:</label>
          <input type="text" id="time-${formId}" maxlength="4" placeholder="0725">
        </div>
        <div class="form-group">
          <label for="destinationOrigin-${formId}">Dest/Orig:</label>
          <input type="text" id="destinationOrigin-${formId}" placeholder="MAD">
        </div>
        <div class="form-group">
          <label for="serviceType-${formId}">Service:</label>
          <select id="serviceType-${formId}">
            <option value="P">P</option>
            <option value="J">J</option>
            <option value="D">D</option>
            <option value="K">K</option>
            <option value="X">X</option>
          </select>
        </div>
        <div class="form-group" style="margin-top: 15px; justify-content:flex-start;">
          <button type="button" onclick="showSCR()">SHOW SCR</button>
          <button type="button" onclick="addMoreForm()" style="margin-left:10px;">ADD MORE</button>
          <button 
            type="button" 
            class="delete-button" 
            style="margin-left:10px;" 
            onclick="deleteForm('${formId}')"
          >
            DELETE FORM
          </button>
        </div>
      `;
      formsContainer.appendChild(formWrapper);
      formsData.push({ formId });
    }

    function deleteForm(formId) {
      const index = formsData.findIndex(f => f.formId === formId);
      if (index !== -1) {
        formsData.splice(index, 1);
      }
      const formWrapper = document.getElementById('wrapper-' + formId);
      if (formWrapper) {
        formWrapper.remove();
      }
    }

    function validateSeats(input) {
      if (input.value.length > 3) {
        input.value = input.value.slice(0, 3);
      }
    }

    // Generate day value for SCR message
    function getDayValue(date) {
      const dayValues = {
        'Sunday': '0000007',
        'Monday': '1000000',
        'Tuesday': '0200000',
        'Wednesday': '0030000',
        'Thursday': '0004000',
        'Friday': '0000500',
        'Saturday': '0000060'
      };
      const dayName = new Intl.DateTimeFormat('en-US', { weekday: 'long' }).format(date);
      return dayValues[dayName];
    }

    function removeOldAirportContainers() {
      const existingContainers = document.querySelectorAll('.airport-container');
      existingContainers.forEach((container) => container.remove());
    }

    function showSCR() {
      removeOldAirportContainers();

      // Gather data
      formsData.forEach(entry => {
        const { formId } = entry;
        const slotType = document.getElementById(`slotType-${formId}`).value;
        const airportCode = document.getElementById(`airportCode-${formId}`).value.toUpperCase();
        const flightNumber = document.getElementById(`flightNumber-${formId}`).value;
        const dateInput = document.getElementById(`date-${formId}`).value;
        const numberOfSeats = document.getElementById(`numberOfSeats-${formId}`).value.padStart(3, '0');
        const aircraftType = document.getElementById(`aircraftType-${formId}`).value.toUpperCase();
        const time = document.getElementById(`time-${formId}`).value.padStart(4, '0');
        const destinationOrigin = document.getElementById(`destinationOrigin-${formId}`).value.toUpperCase();
        const serviceType = document.getElementById(`serviceType-${formId}`).value;

        entry.slotType = slotType;
        entry.airportCode = airportCode;
        entry.flightNumber = flightNumber;
        entry.dateInput = dateInput;
        entry.numberOfSeats = numberOfSeats;
        entry.aircraftType = aircraftType;
        entry.time = time;
        entry.destinationOrigin = destinationOrigin;
        entry.serviceType = serviceType;
      });

      // Validate
      for (const formObj of formsData) {
        const {
          airportCode,
          flightNumber,
          dateInput,
          numberOfSeats,
          aircraftType,
          time,
          destinationOrigin
        } = formObj;
        if (!airportCode || !flightNumber || !dateInput || !numberOfSeats || !aircraftType || !time || !destinationOrigin) {
          alert("Please fill in all required fields in each form.");
          return;
        }
      }

      // Group by airport
      const airportGroups = {};
      formsData.forEach(formObj => {
        const date = new Date(formObj.dateInput);
        const dayValue = getDayValue(date);
        const day = date.getDate().toString().padStart(2, '0');
        const monthNames = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
        const month = monthNames[date.getMonth()];
        const formattedDate = `${day}${month}`;
        let scrTypeIndicator = slotAction === "CANCEL SLOT" ? "D" : slotAction === "NEW SLOT" ? "N" : "C";

        let scrMessage = `
SCR  
W24  
${formattedDate}  
${formObj.airportCode}  
`;
        if (formObj.slotType === "ARRIVAL") {
          scrMessage += `${scrTypeIndicator}${formObj.flightNumber} ${formattedDate}${formattedDate} ${dayValue} ${formObj.numberOfSeats}${formObj.aircraftType} ${formObj.destinationOrigin}${formObj.time} ${formObj.serviceType}  
SI ${slotAction} REQ ${formObj.airportCode}`;
        } else {
          // DEPARTURE
          scrMessage += `${scrTypeIndicator} ${formObj.flightNumber} ${formattedDate}${formattedDate} ${dayValue} ${formObj.numberOfSeats}${formObj.aircraftType} ${formObj.time}${formObj.destinationOrigin} ${formObj.serviceType}  
SI ${slotAction} REQ ${formObj.airportCode}`;
        }

        const trimmedSCR = scrMessage.trim();
        logData.push({ slotAction, scrMessage: trimmedSCR });

        if (!airportGroups[formObj.airportCode]) {
          airportGroups[formObj.airportCode] = [];
        }
        airportGroups[formObj.airportCode].push({
          scrMessage: trimmedSCR,
          slotAction
        });
      });

      displayAirportGroups(airportGroups);
    }

    function displayAirportGroups(airportGroups) {
      const formsContainer = document.getElementById('formsContainer');
      Object.keys(airportGroups).forEach(airportCode => {
        const container = document.createElement('div');
        container.classList.add('airport-container');

        const header = document.createElement('div');
        header.classList.add('airport-header');
        header.innerHTML = `
          <span>${airportCode}</span>
          <button type="button" onclick="toggleSCRMessages(this)">Expand/Collapse</button>
        `;

        const messagesWrapper = document.createElement('div');
        messagesWrapper.classList.add('scr-messages');

        airportGroups[airportCode].forEach(entry => {
          const msgDiv = document.createElement('div');
          msgDiv.classList.add('scr-message');
          msgDiv.textContent = entry.scrMessage;
          messagesWrapper.appendChild(msgDiv);
        });

        const emailBtn = document.createElement('button');
        emailBtn.textContent = 'EMAIL SCR';
        emailBtn.classList.add('email-scr-btn');
        emailBtn.onclick = () => emailSCRGrouped(airportCode, airportGroups[airportCode]);

        container.appendChild(header);
        container.appendChild(emailBtn);
        container.appendChild(messagesWrapper);
        formsContainer.appendChild(container);
      });
    }

    function toggleSCRMessages(button) {
      const airportContainer = button.closest('.airport-container');
      const scrMessages = airportContainer.querySelector('.scr-messages');
      if (scrMessages.style.display === 'none' || scrMessages.style.display === '') {
        scrMessages.style.display = 'block';
      } else {
        scrMessages.style.display = 'none';
      }
    }

    function emailSCRGrouped(airportCode, scrArray) {
      if (!scrArray || scrArray.length === 0) {
        alert("No SCR message to email. Generate it first.");
        return;
      }
      const emailList = airportEmails[airportCode]?.email;
      const ccEmail = "slotdesk@ryanair.com";
      if (!emailList) {
        alert(`No email found for airport code: ${airportCode}`);
        return;
      }
      const combinedSCR = scrArray.map(item => item.scrMessage).join('\n\n');
      const subject = encodeURIComponent(`${slotAction} REQ ${airportCode}`);
      const body = encodeURIComponent(combinedSCR);
      const mailtoLink = `mailto:${emailList}?cc=${ccEmail}&subject=${subject}&body=${body}`;
      window.location.href = mailtoLink;
    }

    /********************************************************
      SHOW LOG & DOWNLOAD CSV
    ********************************************************/
    function showLog() {
      const logContainer = document.getElementById('logContainer');
      const logTableBody = document.querySelector("#logTable tbody");
      logTableBody.innerHTML = "";

      logData.forEach(log => {
        const row = logTableBody.insertRow();
        const cellAction = row.insertCell(0);
        const cellMessage = row.insertCell(1);
        cellAction.textContent = log.slotAction;
        cellMessage.textContent = log.scrMessage;
      });

      if (logData.length > 0) {
        logContainer.style.display = "block";
        logContainer.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      } else {
        logContainer.style.display = "none";
      }
    }

    function downloadCSV() {
      if (logData.length === 0) {
        alert("No log data available to download.");
        return;
      }
      const csvContent = [
        ["Slot Action", "SCR Message"],
        ...logData.map(log => [log.slotAction, log.scrMessage.replace(/\n/g, " ")])
      ]
      .map(row => row.map(field => `"${field}"`).join(","))
      .join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "scr_log.csv");
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    /********************************************************
      "CHANGE SCR" (SCR Change Requests) LOGIC
    ********************************************************/
    function toggleChangeSCR() {
      const container = document.getElementById('changeSCRContainer');
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        container.scrollIntoView({ behavior: 'smooth' });
      } else {
        container.style.display = 'none';
      }
    }

    function addFormsPair() {
      requestCount++;
      const clone = formsTemplate.content.cloneNode(true);
      const heading = clone.querySelector('h3');
      if (heading) heading.textContent = `Request #${requestCount}`;

      // Force uppercase for the text inputs in the "change request" section:
      const textInputs = clone.querySelectorAll('input[type="text"]');
      textInputs.forEach(input => {
        input.addEventListener('input', () => {
          input.value = input.value.toUpperCase();
        });
      });

      formsWrapper.appendChild(clone);
    }

    function showSCRMessagesChange() {
      outputList.innerHTML = '';
      const containers = formsWrapper.querySelectorAll('.requests-container');
      if (containers.length === 0) {
        outputList.textContent = 'No forms available.';
        return;
      }
      containers.forEach(container => {
        const oldForm = container.querySelector('.old-request-form');
        const newForm = container.querySelector('.new-request-form');
        if (!oldForm || !newForm) return;

        const oldData = getFormDataChange(oldForm);
        const newData = getFormDataChange(newForm);
        const scrMessage = buildSCRMessageChange(oldData, newData);

        const airportCode = oldData.airport || '???';
        const rowDiv = document.createElement('div');
        rowDiv.classList.add('scr-row');

        const infoLeftDiv = document.createElement('div');
        infoLeftDiv.classList.add('scr-info-left');
        const airportSpan = document.createElement('span');
        airportSpan.classList.add('airport-code');
        airportSpan.textContent = airportCode;
        infoLeftDiv.appendChild(airportSpan);

        const buttonGroup = document.createElement('div');
        buttonGroup.classList.add('button-group');

        const emailBtn = document.createElement('button');
        emailBtn.classList.add('email-btn');
        emailBtn.textContent = 'Email';
        emailBtn.addEventListener('click', () => {
          alert('Email button clicked!\n\nMessage:\n' + scrMessage);
        });

        const toggleBtn = document.createElement('button');
        toggleBtn.classList.add('toggle-btn');
        toggleBtn.textContent = '+';

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('scr-message-change');
        msgDiv.textContent = scrMessage;

        toggleBtn.addEventListener('click', () => {
          if (msgDiv.style.display === 'none' || !msgDiv.style.display) {
            msgDiv.style.display = 'block';
            toggleBtn.textContent = '-';
          } else {
            msgDiv.style.display = 'none';
            toggleBtn.textContent = '+';
          }
        });

        buttonGroup.appendChild(emailBtn);
        buttonGroup.appendChild(toggleBtn);

        rowDiv.appendChild(infoLeftDiv);
        rowDiv.appendChild(buttonGroup);

        outputList.appendChild(rowDiv);
        outputList.appendChild(msgDiv);
      });
    }

    function getFormDataChange(formEl) {
      const slotType = formEl.querySelector('select[name="slotType"]')?.value || '';
      const airport  = formEl.querySelector('input[name="airport"]')?.value || '';
      const flightNo = formEl.querySelector('input[name="flightNo"]')?.value || '';
      const date     = formEl.querySelector('input[name="date"]')?.value || '';
      const seats    = formEl.querySelector('input[name="seats"]')?.value || '';
      const acType   = formEl.querySelector('input[name="acType"]')?.value || '';
      const time     = formEl.querySelector('input[name="time"]')?.value || '';
      const doField  = formEl.querySelector('input[name="do"]')?.value || '';
      const stc      = formEl.querySelector('select[name="stc"]')?.value || '';
      return { slotType, airport, flightNo, date, seats, acType, time, doField, stc };
    }

    function buildSCRMessageChange(oldReq, newReq) {
      const seasonCode      = 'W24'; 
      const oldReqDateDDMMM = formatDateToDDMMM(oldReq.date) || '01JAN';
      const oldReqAirport   = oldReq.airport || 'XXX';

      const lineSCR     = 'SCR';
      const lineSeason  = seasonCode;
      const lineDate    = oldReqDateDDMMM;
      const lineAirport = oldReqAirport;

      const lineOld = buildRequestLineChange('C', oldReq);
      const lineNew = buildRequestLineChange('R', newReq);
      const lineSI  = `SI SLOT CHG REQ ${oldReqAirport}`;

      return [
        lineSCR,
        lineSeason,
        lineDate,
        lineAirport,
        lineOld,
        lineNew,
        '',
        lineSI
      ].join('\n');
    }

    function buildRequestLineChange(prefix, req) {
      let flightId;
      if (req.slotType === 'Arrival') {
        flightId = prefix + (req.flightNo || '');
      } else {
        flightId = prefix + ' ' + (req.flightNo || '');
      }
      const dateDDMMM  = formatDateToDDMMM(req.date) || '25DEC';
      const doCode     = getDayOfOperationCodeChange(req.date);
      const acTypeCode = '000' + (req.acType.replace(/\s/g, '') || '');
      let stationTimeSegment;
      if (req.slotType === 'Arrival') {
        stationTimeSegment = (req.doField || '') + (req.time || '');
      } else {
        stationTimeSegment = (req.time || '') + (req.doField || '');
      }

      return [
        flightId,
        dateDDMMM + dateDDMMM,
        doCode,
        acTypeCode,
        stationTimeSegment,
        req.stc
      ].join(' ');
    }

    function formatDateToDDMMM(isoDate) {
      if (!isoDate) return '';
      const [yyyy, mm, dd] = isoDate.split('-');
      if (!yyyy || !mm || !dd) return '';
      const monthNames = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
      const monthIndex = parseInt(mm, 10) - 1;
      if (monthIndex < 0 || monthIndex > 11) return '';
      return dd + monthNames[monthIndex];
    }

    function getDayOfOperationCodeChange(isoDate) {
      if (!isoDate) return '0000000';
      const jsDate = new Date(isoDate);
      if (isNaN(jsDate.getTime())) return '0000000';
      const dayIndex = jsDate.getDay();
      return dayOfOperationMap[dayIndex] || '0000000';
    }

    /********************************************************
      RESET ALL LOGIC
    ********************************************************/
    function resetAll() {
      // 1) Clear main forms data and container
      formsData = [];
      document.getElementById('formsContainer').innerHTML = '';

      // 2) Clear log data and hide log container
      logData = [];
      const logContainer = document.getElementById('logContainer');
      logContainer.style.display = 'none';
      document.querySelector("#logTable tbody").innerHTML = '';

      // 3) Clear change request forms and output
      formsWrapper.innerHTML = '';
      outputList.innerHTML = '';
      requestCount = 0;

      // If you also want to hide the "changeSCRContainer," do so:
      document.getElementById('changeSCRContainer').style.display = 'none';
    }
  </script>
</body>
</html>
