<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Airport Management</title>
    <style>
        /* Existing Styles */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        header {
            background: linear-gradient(135deg, #007BFF, #0056b3);
            color: white;
            text-align: center;
            padding: 30px 20px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: bold;
        }

        header nav a {
            color: #FFD700;
            text-decoration: none;
            font-weight: bold;
        }

        .container {
            max-width: 800px; /* Increased width for better layout */
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 20px;
            text-align: center;
        }

        h2, h3 {
            font-size: 1.8rem;
            color: #007BFF;
            margin-bottom: 20px;
        }

        input, select, textarea {
            width: 100%;
            margin-bottom: 15px;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #007BFF;
            outline: none;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.3);
        }

        button {
            padding: 12px 20px;
            font-size: 1rem;
            color: white;
            background: linear-gradient(135deg, #007BFF, #0056b3);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease, transform 0.2s ease;
            margin: 5px;
        }

        button:hover {
            background: linear-gradient(135deg, #0056b3, #003f7f);
            transform: translateY(-2px);
        }

        .results, .recent-searches, #airportManagement {
            margin-top: 20px;
            text-align: left;
            background: #f9f9ff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }

        .results p, .recent-searches p {
            margin: 10px 0;
            font-size: 1rem;
            line-height: 1.5;
            color: #555;
        }

        .results p strong, .recent-searches h3 {
            color: #007BFF;
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            position: absolute;
            width: calc(100% - 40px); /* Adjusted for padding */
            z-index: 1000;
        }

        ul li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        ul li:hover {
            background: #f0f0f0;
        }

        #autocompleteList {
            position: relative;
        }

        .airport-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9ff;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .airport-row div {
            flex: 1;
            text-align: left;
        }

        .airport-row button {
            margin-left: 5px;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .dark-mode {
            background-color: #121212;
            color: white;
        }

        .dark-mode .container, .dark-mode .results, .dark-mode .recent-searches, .dark-mode #airportManagement {
            background: #1f1f1f;
            color: white;
        }

        .dark-mode input, .dark-mode select, .dark-mode textarea {
            background: #333;
            color: white;
            border: 2px solid #555;
        }

        .dark-mode ul {
            background: #333;
            border: 1px solid #555;
        }

        .dark-mode ul li:hover {
            background: #444;
        }

        .dark-mode button {
            background: #555;
        }

        .dark-mode button:hover {
            background: #444;
        }
    </style>
</head>
<body>
    <header>
        <h1>Enhanced Airport Management</h1>
        <nav style="margin-bottom: 20px;">
            <a href="index.html" style="
                display: inline-block;
                padding: 8px 12px;
                background-color: #3498db;
                color: #fff;
                text-decoration: none;
                border-radius: 4px;
            ">
                Back to Home
            </a>
        </nav>
    </header>

    <!-- Search Container -->
    <div class="container">
        <button id="themeToggle">Toggle Dark Mode</button>
        <h2>Search for an Airport</h2>
        <div style="position: relative;">
            <input type="text" id="airportCode" placeholder="Enter Airport Code (e.g., VLC)" autocomplete="off">
            <ul id="autocompleteList" style="display: none;"></ul>
        </div>
        <button onclick="searchAirport()">Search</button>
        <div id="results" class="results"></div>
    </div>

    <!-- Recent Searches -->
    <div id="recentSearches" class="recent-searches container">
        <h3>Recently Searched Airports</h3>
        <ul id="recentSearchesList"></ul>
    </div>

    <!-- Airport Management -->
    <div id="airportManagement" class="container">
        <h2>Airport Management</h2>
        <div id="airportContainer"></div>
        <div id="formContainer">
            <h3 id="formTitle">Add Airport</h3>
            <form id="airportForm">
                <input type="hidden" id="airportId">
                <input type="text" id="newAirportCode" placeholder="Airport Code (e.g., ABZ)" required>
                <input type="text" id="newAirportName" placeholder="Airport Name" required>
                <input type="text" id="newCountry" placeholder="Country" required>
                <input type="email" id="newEmail" placeholder="Email" required>
                <input type="text" id="newContactNumber" placeholder="Contact Number">
                <input type="text" id="newSummerLevel" placeholder="Summer Level">
                <input type="text" id="newWinterLevel" placeholder="Winter Level">
                <label for="newGCR">GCR:</label>
                <select id="newGCR">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
                <label for="newPPR">PPR:</label>
                <select id="newPPR">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                </select>
                <textarea id="newAdditionalInfo" placeholder="Additional Information"></textarea>
                <button type="submit">Save</button>
                <button type="button" id="cancelButton" style="display:none;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Supabase and Application Script -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // Initialize Supabase Client
        const SUPABASE_URL = "https://ykrviyqihpvzpuzvrmqu.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcnZpeXFpaHB2enB1enZybXF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU0ODg0NDUsImV4cCI6MjA1MTA2NDQ0NX0.Dn6m_bYyJe4mvHetBNKTRhavBwkZNv1lqidJ1YPuV3U";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // DOM Elements
        const airportCodeInput = document.getElementById("airportCode");
        const autocompleteList = document.getElementById("autocompleteList");
        const resultsDiv = document.getElementById("results");
        const recentSearchesList = document.getElementById("recentSearchesList");
        const airportContainer = document.getElementById("airportContainer");
        const airportForm = document.getElementById("airportForm");
        const formTitle = document.getElementById("formTitle");
        const cancelButton = document.getElementById("cancelButton");

        let allAirports = []; // To store fetched airports for search and autocomplete
        let recentSearches = []; // To store recent searches (max 5)

        // Fetch All Airports from Supabase on Page Load
        async function fetchAllAirports() {
            const { data, error } = await supabase.from("airports").select("*");
            if (error) {
                console.error("Error fetching airports:", error);
                alert("Failed to fetch airports from the database.");
                return;
            }
            allAirports = data;
            renderAirports(data);
            setupAutocomplete(); // Initialize autocomplete after fetching data
        }

        // Render Airports in Management Section
        function renderAirports(airports) {
            airportContainer.innerHTML = "";
            airports.forEach((airport) => {
                const row = document.createElement("div");
                row.classList.add("airport-row");
                row.innerHTML = `
                    <div>
                        <p><strong>Code:</strong> ${airport.airport_code}</p>
                        <p><strong>Name:</strong> ${airport.airport_name}</p>
                        <p><strong>Country:</strong> ${airport.country}</p>
                        <p><strong>Email:</strong> ${airport.email}</p>
                        <p><strong>Contact:</strong> ${airport.contact_number || "N/A"}</p>
                        <p><strong>Summer Level:</strong> ${airport.summer_level || "N/A"}</p>
                        <p><strong>Winter Level:</strong> ${airport.winter_level || "N/A"}</p>
                        <p><strong>GCR:</strong> ${airport.gcr ? "Yes" : "No"}</p>
                        <p><strong>PPR:</strong> ${airport.ppr ? "Yes" : "No"}</p>
                        <p><strong>Additional Info:</strong> ${airport.additional_information || "N/A"}</p>
                    </div>
                    <div>
                        <button onclick="editAirport(${airport.id})">Edit</button>
                        <button onclick="deleteAirport(${airport.id})">Delete</button>
                    </div>
                `;
                airportContainer.appendChild(row);
            });
        }

        // Search Functionality
        function searchAirport() {
            const query = airportCodeInput.value.trim().toUpperCase();
            resultsDiv.innerHTML = "";

            if (!query) {
                resultsDiv.innerHTML = `<p style="color:red;">Please enter an airport code.</p>`;
                return;
            }

            const airport = allAirports.find(a => a.airport_code === query);

            if (airport) {
                updateRecentSearches(query);
                resultsDiv.innerHTML = `
                    <p><strong>Code:</strong> ${airport.airport_code}</p>
                    <p><strong>Name:</strong> ${airport.airport_name}</p>
                    <p><strong>Country:</strong> ${airport.country}</p>
                    <p><strong>Email:</strong> ${airport.email}</p>
                    <p><strong>Contact:</strong> ${airport.contact_number || "N/A"}</p>
                    <p><strong>Summer Level:</strong> ${airport.summer_level || "N/A"}</p>
                    <p><strong>Winter Level:</strong> ${airport.winter_level || "N/A"}</p>
                    <p><strong>GCR:</strong> ${airport.gcr ? "Yes" : "No"}</p>
                    <p><strong>PPR:</strong> ${airport.ppr ? "Yes" : "No"}</p>
                    <p><strong>Additional Info:</strong> ${airport.additional_information || "N/A"}</p>
                `;
            } else {
                resultsDiv.innerHTML = `<p style="color:red;">No data found for airport code: ${query}</p>`;
            }
        }

        // Update Recent Searches
        function updateRecentSearches(airportCode) {
            if (!recentSearches.includes(airportCode)) {
                if (recentSearches.length === 5) recentSearches.shift();
                recentSearches.push(airportCode);
            }
            renderRecentSearches();
        }

        // Render Recent Searches
        function renderRecentSearches() {
            recentSearchesList.innerHTML = "";
            recentSearches.forEach(code => {
                const li = document.createElement("li");
                li.textContent = code;
                li.style.cursor = "pointer";
                li.addEventListener("click", () => {
                    airportCodeInput.value = code;
                    searchAirport();
                });
                recentSearchesList.appendChild(li);
            });
        }

        // Autocomplete Functionality
        function setupAutocomplete() {
            airportCodeInput.addEventListener("input", () => {
                const query = airportCodeInput.value.trim().toUpperCase();
                autocompleteList.innerHTML = "";
                if (!query) {
                    autocompleteList.style.display = "none";
                    return;
                }

                const matches = allAirports.filter(a => a.airport_code.startsWith(query));
                if (matches.length === 0) {
                    autocompleteList.style.display = "none";
                    return;
                }

                matches.forEach(a => {
                    const li = document.createElement("li");
                    li.textContent = a.airport_code;
                    li.addEventListener("click", () => {
                        airportCodeInput.value = a.airport_code;
                        autocompleteList.innerHTML = "";
                        autocompleteList.style.display = "none";
                        searchAirport();
                    });
                    autocompleteList.appendChild(li);
                });

                autocompleteList.style.display = "block";
            });

            // Hide autocomplete on clicking outside
            document.addEventListener("click", (e) => {
                if (e.target !== airportCodeInput) {
                    autocompleteList.innerHTML = "";
                    autocompleteList.style.display = "none";
                }
            });
        }

        // Add/Edit Airport Form Submission
        airportForm.addEventListener("submit", async (event) => {
            event.preventDefault();

            const id = document.getElementById("airportId").value;
            const airportData = {
                airport_code: document.getElementById("newAirportCode").value.trim().toUpperCase(),
                airport_name: document.getElementById("newAirportName").value.trim(),
                country: document.getElementById("newCountry").value.trim(),
                email: document.getElementById("newEmail").value.trim(),
                contact_number: document.getElementById("newContactNumber").value.trim(),
                summer_level: document.getElementById("newSummerLevel").value.trim(),
                winter_level: document.getElementById("newWinterLevel").value.trim(),
                gcr: document.getElementById("newGCR").value === "true",
                ppr: document.getElementById("newPPR").value === "true",
                additional_information: document.getElementById("newAdditionalInfo").value.trim(),
            };

            try {
                if (id) {
                    // Update existing airport
                    const { error } = await supabase.from("airports").update(airportData).eq("id", id);
                    if (error) throw error;
                    alert("Airport updated successfully.");
                } else {
                    // Insert new airport
                    const { error } = await supabase.from("airports").insert([airportData]);
                    if (error) throw error;
                    alert("Airport added successfully.");
                }
            } catch (error) {
                console.error("Error in form submission:", error);
                alert("An error occurred. Please check the console for details.");
                return;
            }

            resetForm();
            await fetchAllAirports(); // Refresh the list
        });

        // Edit Airport Function
        async function editAirport(id) {
            const { data: airport, error } = await supabase.from("airports").select("*").eq("id", id).single();
            if (error) {
                console.error("Error fetching airport for edit:", error);
                alert("Failed to fetch airport details.");
                return;
            }

            // Populate form with existing data
            formTitle.textContent = "Edit Airport";
            document.getElementById("airportId").value = airport.id;
            document.getElementById("newAirportCode").value = airport.airport_code;
            document.getElementById("newAirportName").value = airport.airport_name;
            document.getElementById("newCountry").value = airport.country;
            document.getElementById("newEmail").value = airport.email;
            document.getElementById("newContactNumber").value = airport.contact_number || "";
            document.getElementById("newSummerLevel").value = airport.summer_level || "";
            document.getElementById("newWinterLevel").value = airport.winter_level || "";
            document.getElementById("newGCR").value = airport.gcr.toString();
            document.getElementById("newPPR").value = airport.ppr.toString();
            document.getElementById("newAdditionalInfo").value = airport.additional_information || "";

            cancelButton.style.display = "inline-block";
        }

        // Delete Airport Function
        async function deleteAirport(id) {
            if (!confirm("Are you sure you want to delete this airport? This action cannot be undone.")) return;

            try {
                const { error } = await supabase.from("airports").delete().eq("id", id);
                if (error) throw error;
                alert("Airport deleted successfully.");
            } catch (error) {
                console.error("Error deleting airport:", error);
                alert("Failed to delete airport.");
                return;
            }

            await fetchAllAirports(); // Refresh the list
        }

        // Cancel Edit Function
        cancelButton.addEventListener("click", () => {
            resetForm();
        });

        // Reset Form Function
        function resetForm() {
            airportForm.reset();
            formTitle.textContent = "Add Airport";
            document.getElementById("airportId").value = "";
            cancelButton.style.display = "none";
        }

        // Toggle Dark Mode
        document.getElementById("themeToggle").addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
        });

        // Real-Time Updates (Optional)
        supabase
            .channel('realtime:airports')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'airports' }, payload => {
                console.log('Change received:', payload);
                fetchAllAirports();
            })
            .subscribe();

        // Initialize Autocomplete
        // Moved setupAutocomplete call inside fetchAllAirports to ensure data is loaded first

        // Fetch Airports on Page Load
        fetchAllAirports();
    </script>
</body>
</html>
